#server {
#        listen 80;
#        server_name www.crowdcrafting.org;
#        #rewrite ^(.*) http://crowdcrafting.org$1 permanent;
#        return 301 http://crowdcrafting.org$request_uri;
#}

geoip_country /etc/nginx/geoip/GeoIP.dat;
geoip_city /etc/nginx/geoip/GeoLiteCity.dat;

server {
    listen 80;
    server_name  _;
    large_client_header_buffers 4 32k;
    real_ip_header X-Forwarded-For;
    root /home/pybossa/pybossa;
    client_max_body_size 5M;

if (-f /home/pybossa/pybossa/503.html) {
    return 503;
}

error_page 503 @maintenance;

location / { try_files $uri @pybossa; }

location @pybossa {
    include uwsgi_params;
    uwsgi_pass unix:/tmp/pybossa.sock;
    add_header X-Real-IP $remote_addr;
    add_header X-Geo-IP $geoip_country_code;
    add_header Set-Cookie language=$geoip_country_code;
}

location  /static {
            alias /home/pybossa/pybossa/pybossa/themes/default/static;
            autoindex on;
            expires max;
        }

location ~ /api/app {
        rewrite ^/api/app /api/project$1 permanent;
}

location ~ /app {
        rewrite ^/app(.*) /project$1 permanent;
}

error_page 503 @maintenance;

location @maintenance {
    if ($uri !~ ^/static/) {
          rewrite ^(.*)$ /503.html break;
        }
}

}
